name: Update Hall of Fame

on:
  watch:
    types: [started]  # Trigger on Star
  workflow_dispatch:  # Manual Trigger

jobs:
  inject-face:
    runs-on: ubuntu-latest
    permissions:
      contents: write 

    steps:
    - uses: actions/checkout@v3

    - name: Python Script
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Add User to Grid
      env:
        USER_LOGIN: ${{ github.actor }}
        USER_AVATAR: ${{ github.event.sender.avatar_url }}
        USER_URL: ${{ github.event.sender.html_url }}
      run: |
        python -c "import os, re, sys

        user_login = os.environ['USER_LOGIN']
        user_avatar = os.environ['USER_AVATAR']
        user_url = os.environ['USER_URL']
        
        # PRO STYLE: Circular Image with Tooltip and Gold/Red Border
        # ·àµ·ä≠·à™·çï·â± ·ä†·ã≤·àµ ·àò·àµ·àò·à≠ ·ä†·ã≠·çà·å•·à≠·àù (No newline char)
        new_entry = f'<a href=\"{user_url}\" title=\"{user_login}\"><img src=\"{user_avatar}\" width=\"50px\" style=\"border-radius: 50%; border: 2px solid #FFD700; margin: 3px; box-shadow: 0px 0px 5px rgba(255, 215, 0, 0.5);\" /></a> '

        file_path = 'README.md'
        
        try:
            with open(file_path, 'r') as f:
                content = f.read()
            
            # Check if user exists
            if user_login in content:
                print(f'User {user_login} is already a King.')
                sys.exit(0)

            # Find markers
            start_marker = '<!-- STARG_START -->'
            end_marker = '<!-- STARG_END -->'
            
            # The regex ensures we insert between markers without deleting existing ones
            pattern = re.compile(f'({start_marker})(.*?)({end_marker})', re.DOTALL)
            match = pattern.search(content)
            
            if match:
                current_members = match.group(2)
                # Append NEW user right after the start marker (At the front)
                # ·ã´·àµ·â∞·ãç·àâ·ç° ·ä•·ãö·àÖ ·åã·à≠ ·àù·äï·àù \n (NewLine) ·ã®·àà·àù·ç¢
                new_content = content.replace(current_members, f'{new_entry}{current_members}')
                
                with open(file_path, 'w') as f:
                    f.write(new_content)
                print(f'Successfully added {user_login} to the throne.')
            else:
                print('Error: Throne markers not found.')
                sys.exit(1)

        except Exception as e:
            print(f'Error: {e}')
            sys.exit(1)
        "

    - name: Commit Change
      run: |
        git config --global user.name "Royal-Guard-Bot"
        git config --global user.email "guard@cipher.kingdom"
        git diff --quiet && git diff --staged --quiet || (git add README.md && git commit -m "üëë A new King has arrived: ${{ github.actor }}" && git push)