name: Update Wall

on:
  watch:
    types: [started]
  workflow_dispatch:

jobs:
  build-wall:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Fetch Stargazers and Rebuild Wall
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO_NAME: ${{ github.repository }}
      run: |
        python -c "
        import os
        import requests
        import sys

        repo = os.environ['REPO_NAME']
        token = os.environ['GH_TOKEN']
        
        # 1. áˆ˜áˆ¨áŒƒá‹áŠ• áŠ¨ GitHub API áˆ›áˆáŒ£á‰µ (á‰µáŠ­áŠ­áˆˆáŠ›á‹áŠ• áˆ˜áˆ¨áŒƒ á‰¥á‰»)
        headers = {'Authorization': f'token {token}'}
        try:
            r = requests.get(f'https://api.github.com/repos/{repo}/stargazers', headers=headers)
            users = r.json()
        except Exception as e:
            print('API Error:', e)
            sys.exit(1)

        # 2. á‹¨ Grid HTML áˆ›á‹˜áŒ‹áŒ€á‰µ (á•áˆ® áŒáˆµ á‰¥á‰»)
        html_content = '<div style=\"display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;\">'
        
        for user in users:
            # áˆ‰á• á‹áˆµáŒ¥ áˆ†áŠ– áˆµáˆ›á‰¸á‹áŠ• áŠ¥áŠ“ áá‰·á‰¸á‹áŠ• á‹«á‹˜áŒ‹áŒƒáˆ
            u_name = user['login']
            u_avatar = user['avatar_url']
            u_url = user['html_url']
            
            card = f'''
            <a href=\"{u_url}\" title=\"{u_name}\">
                <img src=\"{u_avatar}\" width=\"50\" height=\"50\" style=\"border-radius: 50%; border: 2px solid #FFD700;\" alt=\"{u_name}\">
            </a>
            '''
            html_content += card
            
        html_content += '</div>'

        # 3. á‹á‹­áˆ‰áŠ• áˆ›áŠ•á‰ á‰¥ áŠ¥áŠ“ á‰¦á‰³á‹áŠ• áˆ˜á‰°áŠ«á‰µ
        file_path = 'README.md'
        with open(file_path, 'r') as f:
            readme = f.read()

        start_marker = '<!-- START_WALL -->'
        end_marker = '<!-- END_WALL -->'

        if start_marker in readme and end_marker in readme:
            # áŠ¨áˆ˜áŒ€áˆ˜áˆªá‹«á‹ áˆ›áˆ­áŠ¨áˆ­ áŠ¥áˆµáŠ¨ áˆ˜áŒ¨áˆ¨áˆ»á‹ áˆ›áˆ­áŠ¨áˆ­ á‹«áˆˆá‹áŠ• á‰ áˆ™áˆ‰ á‰ áŠ á‹²áˆ± HTML á‹­á‰°áŠ«áˆ
            # á‹­áˆ„ áŠá‹ á‹µáŒáŒáˆáˆ½áŠ• á‹¨áˆšá‹«áŒ á‹á‹ áˆ›áŒ‚áŠ­
            part1 = readme.split(start_marker)[0]
            part2 = readme.split(end_marker)[1]
            
            new_readme = f'{part1}{start_marker}\n{html_content}\n{end_marker}{part2}'
            
            with open(file_path, 'w') as f:
                f.write(new_readme)
            print('Wall rebuilt successfully!')
        else:
            print('Markers not found!')
        "

    - name: Commit Changes
      run: |
        git config --global user.name "Wall-Bot"
        git config --global user.email "bot@cipher.com"
        git diff --quiet || (git add README.md && git commit -m "ğŸš§ Rebuilt the Wall" && git push)