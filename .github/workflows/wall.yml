name: Update Wall

on:
  watch:
    types: [started]  # áˆ°á‹ Star áˆ²á‹«á‹°áˆ­áŒ á‰¥á‰» á‹­áŠáˆ³áˆ
  workflow_dispatch:  # áŠ¥áˆ«áˆµáˆ… Run áˆ›á‹µáˆ¨áŒ áŠ¨áˆáˆˆáŒáŠ­

jobs:
  build-hall-of-fame:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Rebuild the Wall
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO_NAME: ${{ github.repository }}
      run: |
        # áŠ áˆµáˆáˆ‹áŒŠ á‹¨áˆ†áŠ‘ Library áˆ˜áŒ«áŠ•
        pip install requests

        python -c "
        import os
        import requests
        import sys

        # 1. áˆ˜áˆ¨áŒƒá‹á‰½áŠ• áˆ›áˆ°á‰£áˆ°á‰¥
        repo = os.environ['REPO_NAME']
        token = os.environ['GH_TOKEN']
        headers = {'Authorization': f'token {token}'}

        print(f'Fetching Stargazers for {repo}...')

        # GitHub API á‰°áŒ á‰…áˆ˜áŠ• áŠ¥áˆµáŠ¨ 100 á‹¨áˆšáˆ†áŠ‘ Star á‹«á‹°áˆ¨áŒ‰ áˆ°á‹á‰½áŠ• áŠ¥áŠ“áˆ˜áŒ£áˆˆáŠ•
        try:
            url = f'https://api.github.com/repos/{repo}/stargazers?per_page=100'
            r = requests.get(url, headers=headers)
            r.raise_for_status()
            users = r.json()
        except Exception as e:
            print(f'Error fetching stars: {e}')
            sys.exit(1)

        # 2. á‹¨HTML Grid áˆ›á‹˜áŒ‹áŒ€á‰µ (Smart Layout)
        # áŠ¥á‹šáˆ… áŒ‹áˆ­ á‹¨áˆáŠ•áˆ°áˆ«á‹ áŠ•áŒ¹áˆ… áŠ á‰€áˆ›áˆ˜áŒ¥ áŠá‹
        html_content = '<div align=\"center\" style=\"display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;\">'

        for user in users:
            login = user['login']
            avatar = user['avatar_url']
            profile_url = user['html_url']
            
            # á‹¨áŠ¥á‹«áŠ•á‹³áŠ•á‹± áˆ°á‹ áŠ«áˆ­á‹µ (Card)
            user_card = f'''
            <a href=\"{profile_url}\" title=\"{login}\">
              <img src=\"{avatar}\" width=\"55\" height=\"55\" style=\"border-radius: 50%; border: 3px solid #FFD700; box-shadow: 0px 0px 8px rgba(255, 215, 0, 0.6);\" alt=\"{login}\">
            </a>'''
            
            html_content += user_card

        html_content += '</div>'

        # 3. README.md á‹á‹­áˆáŠ• áŠ áŠ•á‰¥á‰¦ áˆ›á‹°áˆµ
        file_path = 'README.md'
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                readme = f.read()

            start_marker = '<!-- START_WALL -->'
            end_marker = '<!-- END_WALL -->'

            if start_marker in readme and end_marker in readme:
                # áŠ¨ Start áŠ¥áˆµáŠ¨ End á‹«áˆˆá‹áŠ• á‰†áˆ­áŒ áŠ• á‰ áŠ á‹²áˆ± áŠ•áŒ¹áˆ… áˆŠáˆµá‰µ áŠ¥áŠ•á‰°áŠ«áˆˆáŠ•
                before = readme.split(start_marker)[0]
                after = readme.split(end_marker)[1]
                
                # áŠ á‹²áˆ±áŠ• á‹á‹­áˆ áˆ˜ááŒ áˆ­
                new_readme = f'{before}{start_marker}\n<br/>\n{html_content}\n<br/>\n{end_marker}{after}'
                
                with open(file_path, 'w', encoding='utf-8') as f:
                    f.write(new_readme)
                print('Success: Wall rebuilt with valid stars.')
            else:
                print('Error: Could not find HTML markers in README.')
                sys.exit(1)
        except Exception as e:
            print(f'File Error: {e}')
            sys.exit(1)
        "

    - name: Commit and Push
      run: |
        git config --global user.name "Hall-Of-Fame-Bot"
        git config --global user.email "bot@cipher.army"
        # áˆˆá‹áŒ¥ áŠ«áˆˆ á‰¥á‰» Commit áŠ á‹µáˆ­áŒ (Error áŠ¥áŠ•á‹³á‹­áˆáŒ¥áˆ­)
        git diff --quiet || (git add README.md && git commit -m "ğŸ‘‘ Updated the Throne Room" && git push)
